services:
  # 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        # 构建阶段使用代理（仅后端）
        HTTP_PROXY: ${HTTP_PROXY:-}
        HTTPS_PROXY: ${HTTPS_PROXY:-}
        NO_PROXY: ${NO_PROXY:-localhost,127.0.0.1,host.docker.internal,mirrors.aliyun.com}
    container_name: comicforge-backend
    ports:
      - "7864:7864"
    volumes:
      # 挂载数据目录（持久化数据，包含config.json）
      # config.json 位于 storage/config.json，可以通过挂载的storage目录访问和修改
      - ./storage:/app/storage
    extra_hosts:
      # 让容器内访问宿主机代理（需要 Docker 20.10+）
      - "host.docker.internal:host-gateway"
    env_file:
      # 从 .env 文件加载环境变量
      - .env
    environment:
      # 可以通过环境变量覆盖配置
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      # LLM API Key（从 .env 文件读取）
      - XAI_API_KEY=${XAI_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Civitai API Token（从 .env 文件读取）
      - CIVITAI_API_TOKEN=${CIVITAI_API_TOKEN:-}
      # 仅后端容器走代理；Aliyun 直连，避免经代理失败
      - http_proxy=${HTTP_PROXY:-}
      - https_proxy=${HTTPS_PROXY:-}
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - no_proxy=${NO_PROXY:-localhost,127.0.0.1,host.docker.internal,mirrors.aliyun.com}
      - NO_PROXY=${NO_PROXY:-localhost,127.0.0.1,host.docker.internal,mirrors.aliyun.com}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7864/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - comicforge-network

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: comicforge-frontend
    ports:
      - "7863:80"
    # 注意：Vite 环境变量需要在构建时注入（在 Dockerfile.frontend 中设置）
    # 运行时不需要环境变量，因为前端通过 nginx 代理 /api 到后端
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - comicforge-network

networks:
  comicforge-network:
    driver: bridge

# 注意：我们使用绑定挂载（bind mounts）而不是命名卷（named volumes）
# 如果需要使用命名卷，可以取消注释以下内容：
# volumes:
#   storage-data:
#   storage-temp:
