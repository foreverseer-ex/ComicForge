services:
  # 后端服务
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: comicforge-backend
    ports:
      - "7864:7864"
    volumes:
      # 挂载配置文件（可选，如果需要修改配置）
      - ./config.json:/app/config.json:ro
      # 挂载数据目录（持久化数据）
      - ./storage:/app/storage
    environment:
      # 可以通过环境变量覆盖配置
      - PYTHONPATH=/app/src
      - PYTHONUNBUFFERED=1
      # LLM API Key（如果需要）
      # - XAI_API_KEY=${XAI_API_KEY}
      # - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Civitai API Token（如果需要）
      # - CIVITAI_API_TOKEN=${CIVITAI_API_TOKEN}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7864/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - comicforge-network

  # 前端服务
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: comicforge-frontend
    ports:
      - "7863:80"
    # 注意：Vite 环境变量需要在构建时注入（在 Dockerfile.frontend 中设置）
    # 运行时不需要环境变量，因为前端通过 nginx 代理 /api 到后端
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - comicforge-network

networks:
  comicforge-network:
    driver: bridge

# 注意：我们使用绑定挂载（bind mounts）而不是命名卷（named volumes）
# 如果需要使用命名卷，可以取消注释以下内容：
# volumes:
#   storage-data:
#   storage-temp:
