# 内容解析功能技术栈

## 文件格式支持计划

### 1. TXT 文件（已实现）
- **核心库：** Node.js 内置 `fs` 模块
- **编码处理：** `iconv-lite` - 处理多种编码（UTF-8、GBK、GB2312 等）
- **编码检测：** `chardet` 或 `jschardet`（可选，用于自动检测编码）
- **实现要点：**
  - 自动检测编码（优先 UTF-8，失败则尝试 GBK）
  - 按行分割文本
  - 正则表达式识别章节标题
  - 支持自定义章节识别规则

### 2. Word 文件（待实现）
- **核心库：** `mammoth` - 将 .docx 转换为 HTML/Markdown，保留格式
- **备选：** `docx` - 直接解析 .docx 的 XML 结构
- **实现要点：**
  - 提取段落文本
  - 识别标题样式（Heading 1/2/3）作为章节
  - 处理列表、表格等复杂结构
  - 保留段落结构

### 3. PDF 文件（待实现）
- **核心库：** `pdf-parse` - 简单易用，适合纯文本 PDF
- **备选：** `pdfjs-dist`（Mozilla）- 功能更强，支持复杂布局
- **实现要点：**
  - 提取文本内容
  - 处理分页（合并跨页段落）
  - 识别章节标题（基于格式或位置）
  - 扫描版 PDF 需要 OCR（如 `tesseract.js`），但通常不需要

## 章节识别策略

### 技术方案
- 正则表达式匹配常见章节格式
- 可配置的识别规则（用户自定义）
- 支持多级章节（章、节、小节）

### 常见模式
- 中文：`第[一二三四五六七八九十百千万\d]+章`
- 英文：`Chapter\s+\d+`、`Chapter\s+[IVX]+`
- 数字：`\d+\.\s+`、`\d+-\d+`

## 文件上传处理

### 技术栈
- Next.js API Route 接收 `FormData`
- 直接使用 Next.js 的 `request.formData()`
- 文件大小限制（建议 50MB）
- 文件类型验证（MIME type 检查）

## 解析流程设计

### 处理流程
1. 上传文件 → 保存到临时目录或直接处理
2. 根据文件类型选择解析器
3. 解析文本内容
4. 识别章节结构
5. 批量写入数据库（使用事务）
6. 更新项目统计信息（总行数、总章节数）
7. 清理临时文件

## 性能优化考虑

### 技术要点
- 流式处理大文件（避免一次性加载到内存）
- 批量数据库操作（使用 `createMany` 或事务）
- 异步处理（可选后台任务队列）
- 进度反馈（WebSocket 或 Server-Sent Events）

## 错误处理

### 需要处理的情况
- 文件格式不支持
- 文件损坏或无法解析
- 编码识别失败
- 章节识别失败（降级为单章节处理）
- 数据库写入失败（回滚事务）
